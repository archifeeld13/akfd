<script>
// 각 이미지에 달리는 캡션은, 이미지의 제목을 키로해서 저장된다
var captions = {};

$(function(){

	// 업로드 혹은 수정을 마친다는 표현
	// 만약 사진을 업로드하게 되면 이부분 무시하고 섭밋 누름
	$('#feeldup-submit-link').click(function(){
		if ($('#input_post_title').val().length == 0 ){
			alert('제목을 입력해 주세요;)') 	
			return 
		}
		// 완전히 끝이라는 표시
		$('#finish').val('1');

		$('#feeldup-submit').click();

		captions = {};
		$('#finish').val('0');
	})
	
	// captions에 들어있는 JSON데이터를 string화해서 captions 히든태그에 value로 넣는다 
	// 서버에서는 이걸 열어봐서 JSON파싱한 이후에 캡션의 업데이트 혹은 생성 여부를 판단한다.
	$('#feeldup-submit').click(function(){
		$('body').LoadingOverlay("show")
		$('#captions').val(JSON.stringify(captions, null, 1))
	})

})
</script>
<style>
	a{
		color: black;	
	}
	#form_container_for_photoup textarea {
		background-color: white !important;
	}
	.preview-img{
		position: relative;
		width: 60%;	
	}

	textarea{
		overflow:hidden;
		font-size: 1.5em !important;
		width: 100%;
	}

	input[type="text"]{
		font-size: 1.5em;
		width: 100%;
	}
	
	input:focus,
	textarea:focus{
		outline: none;
	}

	.makebinder{
		width: 100%;	
		height: 50px;
	}

</style>



<!-- 에디터 시작  -->
<!-- 에디터 시작  -->
<!-- 에디터 시작  -->
<!-- 에디터 시작  -->
<div class="container">

<!-- edit-super-container -->
<!-- edit-super-container -->
<!-- edit-super-container -->
<!-- 요소들의 절대 위치를 원활히 지정하기 위해선 부모가 relative여야만 하는것 같다 -->
<div id="edit-super-container" style="position:relative">
<%= form_for @post, html: {multipart: true}  do |f| %>
<!-- edit-container -->
<!-- edit-container -->
<!-- edit-container -->
<div id="edit-container" style="position:absolute; left:0; width: 70%; margin-right:1%; margin-bottom:50px; "> 
	<div style="background: white; border-radius: 5px; padding: 10px;">
		<%# 제목 필드 %>
		<%# 제목 필드 %>
		<%# 제목 필드 %>
		<%= f.text_field :title, :id => 'input_post_title', :placeholder => '제목을 입력해 주세요' %>
		
		<%# 사진 추가되는 필드 %>
		<%# 사진 추가되는 필드 %>
		<%# 사진 추가되는 필드 %>
		<div style="margin-bottom: 10px"></div>

		<center>
		<h3>링크 제목 : <%= @object.title%></h3>
		<%= hidden_field_tag :link_title, "#{@object.title}" %>	

		<% if @object.images.any? %>
			<img src="<%=@object.images.first.src.to_s%>" style="width:50%">
			<%= hidden_field_tag :image_url, "#{@object.images.first.src.to_s}" %>	
		<% else %>
			<h2>얻어온 이미지가 없습니다</h2>
			<%= hidden_field_tag :image_url, nil%>	
		<% end %>

		<br>
		<h3>출처 : <%= @link %></h3>
		<%= hidden_field_tag :link_url , "#{@link}"%>	
		</center>

		<%# 내용 필드 %>
		<%# 내용 필드 %>
		<%# 내용 필드 %>
		<div style="margin-bottom: 10px"></div>
		<%= f.text_area :content,  placeholder: "내용을 입력해주세요", rows: '5'%>

		<%# 비밀글 필드 %>
		<%# 비밀글 필드 %>
		<%# 비밀글 필드 %>
		<div class="has-error">
			<div class="checkbox">
				<label style="margin-left: 1%;">
					<%= f.check_box :is_secret %>
					<i class="fa fa-lock"></i>&nbsp;	비공개
				</label>
			</div>
		</div>
	</div>

	<%# 태그 필드 %>
	<%# 태그 필드 %>
	<%# 태그 필드 %>
	<div style="margin-bottom: 15px"></div>
	<div style="background: white; border-radius: 5px;">
		<%= f.text_field :tag_list_fixed, class: 'form-control', placeholder: "태그는 쉼표로 구분해주세요! 예) 도면, 모델" %>
	</div>
</div>
<!-- edit-container end-->
<!-- edit-container end-->
<!-- edit-container end-->

<!-- edit-controller -->
<!-- edit-controller -->
<!-- edit-controller -->
<div id="edit-controller" style="position:fixed; width:20%; height:425px; background:white; padding:1%; overflow-y: auto; overflow-x: hidden; font-size: 1.2em; border-radius: 5px 5px 5px 5px;">
	<center><div style="color:#BBBBBB; font-size:1.1em;">바인더(프로젝트)관리</div></center>
	<%# 프로젝트 리스트 아이템 %>
	<%# 프로젝트 리스트 아이템 %>
	<%# 프로젝트 리스트 아이템 %>
	<div id="project_radio_container">
		<div>
			<%= f.radio_button(:project_id, "") %>
			&nbsp;선택 안함
		</div>
		<% current_user.projects.each do |project| %>
			<%= render 'projects/project_radio', project: project, f: f %>
		<% end %>
	</div>

	<%# 바인더 만들기 버튼 %>
	<%# 바인더 만들기 버튼 %>
	<%# 바인더 만들기 버튼 %>
	<div style="position:absolute; bottom:0; width:90%; height:50px; margin-left: 1%; margin-bottom: 55px;">
		<%= link_to new_user_project_path(current_user.id), remote: true do%>
			<button class="btn btn-block" style="background: white; border: 1px solid black; font-size:1.2em" >바인더 만들기</button>
		<% end %>
	</div>

	<div style="position:absolute; bottom:0; width:90%; height:50px; margin-left: 1%; margin-bottom: 1%;">
		<a href="#" id="feeldup-submit-link" class="btn btn-block" style="background: white; border: 1px solid black; font-size:1.2em"><strong>올리기</strong></a> 
	</div>
</div>
<!-- edit-controller 위치 업데이트 스크립트 -->
<!-- edit-controller 위치 업데이트 스크립트 -->
<!-- edit-controller 위치 업데이트 스크립트 -->
<script>
	$(function(){
		// 바로 호출하면 이전에 content container사이즈를 조정하는 시간? 때문에 left margin값이 -가 나와서 오류가있었다
		// 일단 임시 처방으로 5ms의 딜레이를 주었다
		setTimeout(updatePositionEditContainer, 5);

		$( window ).resize(function() {
			updatePositionEditContainer();
		})
	})

	function updatePositionEditContainer(){
		var left_offset = parseFloat($('#edit-container').offset()["left"])
		var width = parseFloat($("#edit-container").css('width'))
		var extra_offset = 15 // edit-container 와 edit-controller사이의 10px정도의 오프셋 
		$("#edit-controller").css("left", left_offset + width + extra_offset)
	}
	// app/assets/javascripts/posts.js의  function postsColumnResize()에 의존하는 함수
	// app/assets/javascripts/posts.js의  function postsColumnResize()에 의존하는 함수
	// app/assets/javascripts/posts.js의  function postsColumnResize()에 의존하는 함수
	function getLeftMarginOfContentsContainer(){
		//var pWidth = $('.posts-item').width() // 없을 땐 너비를 못찾아서절대값 넣음 
		var pWidth = 260  // 290 -> 260
		var rWidth = $('#right_fixed_menu').width()
		var except_RFM = $(window).width() - (rWidth + 25) // 25 : RFM의 오른쪽 마진
		return (except_RFM - $('#contents-container').width())/2
	}
</script>
<!-- edit-controller end -->
<!-- edit-controller end -->
<!-- edit-controller end -->
		

<%= f.hidden_field(:post_type, value: 2, id: "post_type") %>

<%# 업로드 버튼 직접 클릭시 finish 1로 바뀜%>
<%= hidden_field_tag "finish", 0 %>

<%# 진짜 서브밋 버튼은 여기에 %>
<%= f.button :submit, class: "hidden", id: "feeldup-submit" %>

<% end %>
</div>
<!-- edit-super-container -->
<!-- edit-super-container -->
<!-- edit-super-container -->


<%# 이 큰 버튼은 모바일에서만 보이게 바꾸기 %>
<%# <button id="feeldup-submit-link" class="btn btn-block" style="background: white; border: 1px solid black; font-size:1.2em">업로드</button> %>


<%= javascript_include_tag "autogrow.js" %>
<script>
$('textarea').autogrow({onInitialize: true});	
</script>

</div>
